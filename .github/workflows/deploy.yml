name: Deploy Laravel to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: imaginatics_laravel
          MYSQL_USER: imaginatics
          MYSQL_PASSWORD: imaginations123
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: pdo, pdo_mysql, mysqli, mbstring, xml, ctype, json, openssl, tokenizer, bcmath
        coverage: none

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

    - name: Copy .env
      run: |
        cp .env.example .env
        php artisan key:generate

    - name: Install NPM dependencies
      run: npm ci

    - name: Build assets
      run: npm run build

    - name: Wait for MySQL
      run: |
        while ! mysqladmin ping -h"127.0.0.1" --silent; do
          sleep 1
        done

    - name: Run migrations
      env:
        DB_CONNECTION: mysql
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: imaginatics_laravel
        DB_USERNAME: imaginatics
        DB_PASSWORD: imaginations123
      run: php artisan migrate --force

    - name: Run tests
      run: php artisan test --parallel || echo "No tests configured yet"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Production Server
      run: |
        ssh -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e

          # Ir a la carpeta del proyecto Laravel (DIFERENTE del monol√≠tico)
          cd ${{ secrets.LARAVEL_PROJECT_PATH }}

          echo "üì¶ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd

          echo "üîß Installing Composer dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

          echo "üì¶ Installing NPM dependencies..."
          npm ci

          echo "üé® Building assets..."
          npm run build

          echo "üóÑÔ∏è Running migrations..."
          php artisan migrate --force

          echo "üîÑ Optimizing Laravel..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          echo "üîë Setting permissions..."
          chmod -R 775 storage bootstrap/cache
          chown -R www-data:www-data storage bootstrap/cache

          echo "‚ôªÔ∏è Restarting services..."

          # Instalar servicio systemd si no existe
          if [ ! -f /etc/systemd/system/laravel-v2.service ]; then
            echo "üìù Installing systemd service..."
            cp deployment/laravel-v2.service /etc/systemd/system/
            systemctl daemon-reload
            systemctl enable laravel-v2
          fi

          # Reiniciar servicio Laravel
          systemctl restart laravel-v2

          # Si usas PHP-FPM
          systemctl restart php8.4-fpm 2>/dev/null || echo "PHP-FPM restart skipped"

          # Si usas Nginx
          systemctl reload nginx 2>/dev/null || echo "Nginx reload skipped"

          echo "‚úÖ Laravel deployment completed!"
          echo ""
          echo "üìç App location: ${{ secrets.LARAVEL_PROJECT_PATH }}"
          echo "üåê App URL: http://161.97.100.196:8081"
        EOF

    - name: Verify Deployment
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo ""
        echo "üåê App URL: http://${{ secrets.SERVER_HOST }}"
        echo ""
        echo "‚ö†Ô∏è  IMPORTANTE:"
        echo "   - Las migraciones se ejecutaron autom√°ticamente"
        echo "   - Cache de config/routes/views limpiada"
        echo "   - Permisos configurados correctamente"
